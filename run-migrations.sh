#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–∞ Render.com
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run-migrations.sh "your_database_url"

if [ -z "$1" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ DATABASE_URL"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run-migrations.sh 'postgresql://user:pass@host/db'"
    exit 1
fi

DATABASE_URL=$1

echo "üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π..."
echo "üì¶ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${DATABASE_URL%%@*}@***"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
psql "$DATABASE_URL" -c "SELECT version();" > /dev/null 2>&1

if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_URL"
    exit 1
fi

echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
psql "$DATABASE_URL" -f migrations.sql

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!"
    echo ""
    echo "üîê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è admin –ø–∞—Ä–æ–ª—è"
    echo "üìß Email: admin@wgauto.com"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
    exit 1
fi
